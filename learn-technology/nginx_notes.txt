## nginx-notes
## create at 2018.1.2


在ubuntu下开启nginx服务：必须用sudo ，不然只能在前台运行
在nginx中,nginx默认将其主进程的pid写入到 /usr/local/nginx/nginx/pid。
	保存主进程号,方便对nginx进行操作。例如更新配置文件,关闭nginx服务


sudo /usr/local/nginx/nginx

1、关闭nginx服务
	sudo ./nginx -s stop
	pkill -9 nginx (强行关闭)
	
	
	从容关闭:
		ps -ef | grep nginx  // 找到nginx的主进程号
		kill -QUIT (nginx的主进程号)
		
	如果不想先查找进程号的话,可以直接使用命令
	 kill -QUIT ` cat /run/nginx.pid`（后面的是从保存nginx的主进程号的文件中读取数据）
	 启动nginx的时候保存到制定目录
	 当关闭nginx的时候,再从指定目录读取文件
	
二、学习网址
	1、Nginx开发从入门到精通
		http://tengine.taobao.org/book/
	2、gitbook的网址
		https://wizardforcel.gitbooks.io/nginx-doc/content/Text/1.2_nginxchswhyuseit.html
	3、一个评价比较高的博客
		http://www.cnblogs.com/jingmoxukong/p/5945200.html
	4、讲nginx的一个博客
		http://www.cnblogs.com/languoliang/archive/2013/04/01/nginx.html
		nginx的日志文件位置:、/var/log/nginx
		nginx的配置文件位置:/etc/nginx
		nginx的启动文件位置:/usr/sbin/nginx
			在/etc/init.d/下创建了启动脚本nginx
		nginx的虚拟主机目位置：/usr/share/nginx/www
	5、gitbook上的nginx中文官方文档
		https://wizardforcel.gitbooks.io/nginx-doc/content/
	
upstream big_server_com{
	server 127.0.0.1:8000 weight=5;
	server 127.0.0.1:8002 weight=3;
}

server{
	listen 80;
	server_name big.server.com;
	location /{
		proxy_pass http://big_server_com
	}
}
	
三、笔记
1、nginx性能高的原因和其架构是分不开的。
	1.1、在unix系统中会以daemon的方式在后台运行，后台进程包含一个master进程和多个worker进程。
	1.2、nginx是以多进程的方式来工作的，当然nginx也是支持多线程的方式的，只是我们主流的方式还是多进程的方式,也是nginx的默认方式。
	1.3、多个worker进程之间是对等的,他们同等竞争来自客户端的请求,各个进程之间是独立的,也就是说：一个请求只能在一个worker进程中处理,一个worker进程
		不可能处理别的请求。
		而且，worker进程的个数是可以设置的,一般与cpu的核数一致。
	1.4、nginx在启动后，会有一个master进程和多个worker进程。
		master进程的作用：
			master进程主要用来管理worker进程，包含：接收来自外界的信号，向各worker进程发送信号，监控worker进程的运行状态，
				当worker进程退出后(异常情况下)，会自动重新启动新的worker进程。
			worker进程的主要作用：处理基本的基本的网络事件。
2、worker进程是如何处理请求的？
	根据“二、学习网址的第一个：”，说的是多个worker进程平等竞争，就是当有请求到来以后,多个进程来竞争这一把锁。谁抢到了，那么就由谁来执行这个请求。
	也就是获取锁。
3、nginx的这种多进程的工作方式的好处是什么？
	首先，对于每个worker进程来说，独立的进程，不需要加锁，所以省掉了锁带来的开销，同时在编程以及问题查找时，也会方便很多。
	其次，采用独立的进程，可以让互相之间不会影响，一个进程退出后，其它进程还在工作，服务不会中断，master进程则很快启动新的worker进程。
4、nginx是如何实现高并发的？
	采用异步非阻塞的事件处理机制。eagain
	它们提供了一种机制，让你可以同时监控多个事件，调用他们是阻塞的，但可以设置超时时间，在超时时间之内，如果有事件准备好了，就返回。
	这种机制正好解决了我们上面的两个问题，拿epoll为例(在后面的例子中，我们多以epoll为例子，以代表这一类函数)，当事件没准备好时，放到epoll里面，
	事件准备好了，我们就去读写，当读写返回EAGAIN时，我们将它再次加入到epoll里面。这样，只要有事件准备好了，我们就去处理它，
	只有当所有事件都没准备好时，才在epoll里面等着。这样，我们就可以并发处理大量的并发了。
	这里的并发请求，是指未处理完的请求，线程只有一个，所以同时能处理的请求当然只有一个了，只是在请求间进行不断地切换而已，
	切换也是因为异步事件未准备好，而主动让出的。这里的切换是没有任何代价，你可以理解为循环处理多个准备好的事件，事实上就是这样的。
	与多线程相比，这种事件处理方式是有很大的优势的，不需要创建线程，每个请求占用的内存也很少，没有上下文切换，事件处理非常的轻量级。
	并发数再多也不会导致无谓的资源浪费（上下文切换）。更多的并发数，只是会占用更多的内存而已。
	我之前有对连接数进行过测试，在24G内存的机器上，处理的并发请求数达到过200万。现在的网络服务器基本都采用这种方式
5、一个基本的web服务器来说，事件通常有三种类型，网络事件、信号、定时器。从上面的讲解中知道，网络事件通过异步非阻塞可以很好的解决掉。如何处理信号与定时器？
6、nginx的配置系统
	在nginx.conf配置文件中,包含了若干个配置项。
6.1、配置项由配置指令和指令参数构成。
	配置指令
		配置指令是一个字符串，可以用单引号或者双引号括起来，也可以不括。但是如果配置指令包含空格，一定要引起来。
	指令参数
		指令参数也就是配置指令对应的配置值。使用一个或者多个空格或者TAB字符与指令分开。
		指令的参数有一个或者多个TOKEN串组成。TOKEN串之间由空格或者TAB键分隔。
		
		TOKEN串分为简单字符串或者是复合配置块。
			简单字符串，这个配置指令的参数全部由简单字符串构成。例如：
				error_page   500 502 503 504  /50x.html;
			复合配置块即是由大括号括起来的一堆内容。一个复合配置块中可能包含若干其他的配置指令。例如：
				location / {
					root   /home/jizhao/nginx-book/build/html;
					index  index.html index.htm;
				}
6.2、指令上下文
nginx.conf中的配置信息，根据其逻辑上的意义，对它们进行了分类，也就是分成了多个作用域，或者称之为配置指令上下文。不同的作用域含有一个或者多个配置项。

当前nginx支持的几个指令上下文：
main:	nginx在运行时与具体业务功能（比如http服务或者email服务代理）无关的一些参数，比如工作进程数，运行的身份等。
http:	与提供http服务相关的一些配置参数。例如：是否使用keepalive啊，是否使用gzip进行压缩等。
server:	http服务上支持若干虚拟主机。每个虚拟主机一个对应的server配置项，配置项里面包含该虚拟主机相关的配置。在提供mail服务的代理时，也可以建立若干server.每个server通过监听的地址来区分。
location:	http服务中，某些特定的URL对应的一系列配置项。
mail:	实现email相关的SMTP/IMAP/POP3代理时，共享的一些配置项（因为可能实现多个代理，工作在多个监听地址上）。

指令上下文，可能有包含的情况出现。例如：通常http上下文和mail上下文一定是出现在main上下文里的。
在一个上下文里，可能包含另外一种类型的上下文多次。
例如：如果http服务，支持了多个虚拟主机，那么在http上下文里，就会出现多个server上下文。
			
四、疑问
	1、如何实现公平竞争？



五、nginx的配置项

六、杂记
	1、nginx使用基于事件的模型和依赖于操作系统的机制来高效地在工作进程间分配请求
	2、Geo模块
		这个模块产生变量，这个变量的值依据客户端的ip地址来进行创建
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
		
	